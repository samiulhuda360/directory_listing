{% extends "listing/base.html" %}

{% block title %}Content Generation{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Upload XLS File and Set Number of Sites</h2>
    <form id="upload-form" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
            <label for="xlsx_file" class="form-label">Upload XLS File</label>
            <input type="file" class="form-control" id="xlsx_file" name="xlsx_file" required>
        </div>
        <div class="mb-3">
            <label for="num_sites" class="form-label">Number of Sites</label>
            <input type="number" class="form-control" id="num_sites" name="num_sites" min="1" required>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
    
    <div id="result-message" class="mt-3"></div>
    <div id="progress-bar" class="progress mt-3" style="display: none;">
        <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <ul id="result-list" class="mt-3"></ul>

    <h3 class="mt-5">Download Generated Files</h3>
    <form id="download-form" method="GET">
        <div class="mb-3">
            <label for="file-dropdown" class="form-label">Select a File to Download</label>
            <select id="file-dropdown" class="form-select">
                <option value="" disabled selected>Select a file</option>
            </select>
        </div>
        <button type="button" id="download-btn" class="btn btn-secondary" disabled>Download</button>
    </form>
</div>
<script>
    $(document).ready(function() {
        loadFilesIntoDropdown();
        $('#upload-form').on('submit', function(event) {
            event.preventDefault();
            $('#result-message').html('<p class="text-info">Processing... Please wait.</p>');
            $('#result-list').empty();
            $('#progress-bar').show().find('.progress-bar').css('width', '0%').attr('aria-valuenow', 0).text('0%');
            var formData = new FormData(this);

            $.ajax({
                url: "{% url 'content_gen' %}",
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    // Check if response indicates that processing is in progress
                    if (response.status === 'in_progress' && response.task_id) {
                        checkTaskStatus(response.task_id);
                    } else {
                        // Handle unexpected responses
                        $('#result-message').html('<p class="text-danger">Unexpected response from the server.</p>');
                    }
                },
                error: function(response) {
                    $('#result-message').html('<p class="text-danger">' + (response.responseJSON.message || 'Unknown error') + '</p>');
                }
            });
        });

        function checkTaskStatus(taskId) {
            $.ajax({
                url: '/api/content-gen-status/' + taskId + '/',
                type: 'GET',
                success: function(response) {
                    if (response.status === 'in_progress' || response.status === 'PENDING') {
                        setTimeout(function() {
                            checkTaskStatus(taskId);
                        }, 2000);
                    } else if (response.status === 'single_post_done') {
                        updateProgress(response.meta);
                        setTimeout(function() {
                            checkTaskStatus(taskId);
                        }, 2000);
                    } else if (response.status === 'SUCCESS') {
                        // Ensure you pass the correct data
                        if (Array.isArray(response.result)) {
                            displayFinalResults(response.result);
                        } else {
                            $('#result-message').html('<p class="text-danger">Expected an array of URLs but got: ' + typeof response.result + '</p>');
                        }
                        loadFilesIntoDropdown();
                    } else if (response.status === 'FAILURE') {
                        $('#result-message').html('<p class="text-danger">Task failed: ' + response.message + '</p>');
                    } else {
                        $('#result-message').html('<p class="text-warning">Unexpected task state: ' + response.status + '</p>');
                    }
                },
                error: function() {
                    $('#result-message').html('<p class="text-danger">Error checking task status.</p>');
                }
            });
        }

        function updateProgress(meta) {
            var percentage = Math.round((meta.current / meta.total) * 100);
            $('#progress-bar .progress-bar').css('width', percentage + '%').attr('aria-valuenow', percentage).text(percentage + '%');
            
            // Update the last posted URL if it's not already displayed
            if (meta.last_posted_url && !$('#result-list').find('a[href="' + meta.last_posted_url + '"]').length) {
                $('#result-list').append('<li>Posted URL: <a href="' + meta.last_posted_url + '" target="_blank">' + meta.last_posted_url + '</a></li>');
            }
        }

        function displayFinalResults(results) {
            $('#result-message').html('<p class="text-success">Task completed successfully.</p>');
            $('#progress-bar').hide();
            $('#result-list').empty(); // Clear previous results
            $('#result-list').append('<li><strong>All URLs posted:</strong></li>');
        
            // Ensure results is treated as an array
            if (Array.isArray(results)) {
                results.forEach(function(url) {
                    $('#result-list').append('<li><a href="' + url + '" target="_blank">' + url + '</a></li>');
                });
            } else {
                $('#result-list').append('<li>No URLs posted.</li>');
            }
        
            $('#result-list').append('<li><strong>Total URLs posted: ' + results.length + '</strong></li>');
        }
        
        function loadFilesIntoDropdown() {
            $.ajax({
                url: "{% url 'list_files_geo' %}",
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        const fileDropdown = $('#file-dropdown');
                        fileDropdown.empty().append('<option value="" disabled selected>Select a file</option>');
                        response.files.forEach(function(file) {
                            fileDropdown.append('<option value="' + file + '">' + file + '</option>');
                        });
                        $('#download-btn').prop('disabled', false);
                    } else {
                        $('#result-message').html('<p class="text-danger">No files available for download.</p>');
                    }
                },
                error: function() {
                    $('#result-message').html('<p class="text-danger">Error loading files.</p>');
                }
            });
        }

        $('#download-btn').on('click', function() {
            const selectedFile = $('#file-dropdown').val();
            if (selectedFile) {
                window.location.href = '/download-file-geo/' + selectedFile + '/';
            }
        });
    });    
</script>

{% endblock %}